CREATE DATABASE QLTRUONG
GO
USE QLTRUONG
GO
CREATE TABLE TRUONG
(
	MATRUONG VARCHAR(20) NOT NULL,
	TENTRUONG NVARCHAR(50) NOT NULL,
	
	PRIMARY KEY(MATRUONG),
)
GO
CREATE TABLE THISINH
(
	SOBD VARCHAR(20) NOT NULL,
	HOTEN NVARCHAR(50) NOT NULL,
	NGAYSINH DATE,
	NOISINH NVARCHAR(50),
	NAMDUTHI INT NOT NULL,
	MATRUONG VARCHAR(20) NOT NULL,

	PRIMARY KEY(SOBD),
)
ALTER TABLE dbo.THISINH ADD CONSTRAINT FK_TS FOREIGN KEY(MATRUONG) REFERENCES dbo.TRUONG(MATRUONG)
CREATE TABLE MONTHI
(
	MAMT INT NOT NULL,
	TENMT NVARCHAR(50) NOT NULL,

	PRIMARY KEY(MAMT),
)
GO
CREATE TABLE KETQUA
(
	SOBD VARCHAR(20) NOT NULL,
	MAMT INT NOT NULL,
	DIEMTHI FLOAT NOT NULL,
	GHICHU NVARCHAR(50),

)
ALTER TABLE dbo.KETQUA ADD CONSTRAINT FK_KQ FOREIGN KEY(MAMT) REFERENCES dbo.MONTHI(MAMT)
GO


--Thông tin bảng thí sinh
-- do chưa chèn mã trường bên bảng chứa khóa chính 
INSERT INTO TRUONG(TENTRUONG ,MATRUONG)
VALUES('Chinh', 111260)

INSERT INTO TRUONG(TENTRUONG, MATRUONG)
VALUES('Chinh2', 111222)

INSERT INTO TRUONG(TENTRUONG, MATRUONG)
VALUES('Chinh3', 111297)

INSERT INTO TRUONG(TENTRUONG, MATRUONG)
VALUES('Chinh4', 018)

INSERT INTO THISINH(SOBD, HOTEN, NGAYSINH, NOISINH, NAMDUTHI, MATRUONG)
VALUES(080191000001, N'NGUYỄN THỊ DIỄM TRINH', '2001-07-14', N'BẾN TRE', 2021, 111260)

INSERT INTO THISINH(SOBD, HOTEN, NGAYSINH, NOISINH, NAMDUTHI, MATRUONG)
VALUES(080191000002, N'NGUYỄN THỊ DIỄM HƯƠNG', '2003-01-10', N'BẾN TRE', 2023, 111222)

INSERT INTO THISINH(SOBD, HOTEN, NGAYSINH, NOISINH, NAMDUTHI, MATRUONG)
VALUES(080191000003, N'NGUYỄN THỊ DIỄM QUỲNH ', '2002-11-23', N'BẾN TRE', 2022, 111297)

INSERT INTO THISINH(SOBD, HOTEN, NGAYSINH, NOISINH, NAMDUTHI, MATRUONG)
VALUES(080191000004, N'NGUYỄN THỊ DIỄM HOA ', '2000-10-12', N'BẾN TRE', 2010, 018)

INSERT INTO THISINH(SOBD, HOTEN, NGAYSINH, NOISINH, NAMDUTHI, MATRUONG)
VALUES(080191000005, N'NGUYỄN MINH', '2002-09-10', N'BẾN TRE', 2010, 018)

INSERT INTO THISINH(SOBD, HOTEN, NGAYSINH, NOISINH, NAMDUTHI, MATRUONG)
VALUES(080191000006, N'NGUYỄN THỊ DIỄM ', '2003-05-12', N'BẾN TRE', 2010, 018)

--Thông tin bảng môn thi
INSERT INTO MONTHI(MAMT, TENMT)
VALUES(1, N'Vật lý')

INSERT INTO MONTHI(MAMT, TENMT)
VALUES(2, N'Toán')

INSERT INTO MONTHI(MAMT, TENMT)
VALUES(3, N'Văn')

INSERT INTO MONTHI(MAMT, TENMT)
VALUES(4, N'Sử')

INSERT INTO MONTHI(MAMT, TENMT)
VALUES(5, N'Địa')

INSERT INTO MONTHI(MAMT, TENMT)
VALUES(6, N'Hóa')



--Thông tin bảng kết quả
INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000001, 1, 8.0, N'ĐẠT')

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000002, 1, 7.0, N'ĐẠT')

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000003, 1, 10.0, N'ĐẠT')

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000004, 1, 0.0, N'KHÔNG ĐẠT')

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000005, 1, 3.2, N'KHÔNG ĐẠT')

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000001, 2, 9.0, N'ĐẠT')

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000002, 2, 6.0, N'ĐẠT') 

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000003, 2, 9.5, N'ĐẠT')

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000004, 2, 7.6, N'KHÔNG ĐẠT')

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000005, 2, 2.8, N'KHÔNG ĐẠT')

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000005, 3, 6.4, N'ĐẠT')

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000005, 4, 7.2, N'ĐẠT')

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000005, 5, 5.6, N'ĐẠT')

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000005, 6, 8.8, N'ĐẠT')



--In kết quả của thí sinh có SBD là '080191000001'. Thông tin cần: MAMT, DIEMTHI, GHICHU.
SELECT * FROM dbo.KETQUA   
WHERE KETQUA.SOBD = '80191000001' 

--In kết quả của thí sinh có SBD là '080191000001'. Thông tin cần: MAMT, TENMT, DIEMTHI, GHICHU.
SELECT KQ.SOBD, KQ.MAMT , MT.TENMT, KQ.DIEMTHI, KQ.GHICHU  FROM dbo.KETQUA AS KQ , dbo.MONTHI AS MT
WHERE KQ.MAMT = MT.MAMT AND  KQ.SOBD = '80191000001' 

--In kết quả của tất cả các môn thi của tất cả thí sinh. Thông tin cần: SOBD, HOTEN, NGAYSINH, TENTRUONG, TENMT.
SELECT KQ.SOBD, TS.HOTEN, TS.NGAYSINH, T.TENTRUONG,  MT.TENMT FROM dbo.KETQUA AS KQ , dbo.TRUONG AS T ,dbo.THISINH  AS TS, dbo.MONTHI AS MT
WHERE KQ.SOBD = TS.SOBD AND TS.MATRUONG= T.MATRUONG  AND MT.MAMT = KQ.MAMT

--In danh sách các thí sinh có mã trường là '018', có điểm môn toán <5. Thông tin cần SOBD, HOTEN, NGAYSINH, TENTRUONG, DIEMTHI.
SELECT TS.SOBD, TS.HOTEN, TS.NGAYSINH, T.TENTRUONG, KQ.DIEMTHI FROM dbo.THISINH	AS TS, dbo.TRUONG AS T, dbo.KETQUA AS KQ
WHERE TS.SOBD = KQ.SOBD AND TS.MATRUONG = T.MATRUONG AND TS.MATRUONG = '18' AND KQ.MAMT = '2' AND KQ.DIEMTHI < 5.0

--In kết quả thi môn thi có mã môn thi là 1 của tất cả các thí sinh. Thông tin cần SOBD, HOTEN, TENTRUONG, DIEMTHI.
SELECT TS.SOBD, TS.HOTEN, T.TENTRUONG, KQ.DIEMTHI FROM dbo.THISINH	AS TS, dbo.TRUONG AS T, dbo.KETQUA AS KQ
WHERE TS.SOBD = KQ.SOBD AND TS.MATRUONG = T.MATRUONG AND KQ.MAMT = '1'

--In kết quả thi môn thi có mã môn thi là 1 của tất cả các thí sinh dự thi năm 2010. Danh sách được sắp theo cột điểm thi giảm dần. 
--Thông tin cần SOBD, HOTEN, TENTRUONG, DIEMTHI.
SELECT TS.SOBD, TS.HOTEN, T.TENTRUONG, KQ.DIEMTHI FROM dbo.THISINH	AS TS, dbo.TRUONG AS T, dbo.KETQUA AS KQ
WHERE TS.SOBD = KQ.SOBD AND TS.MATRUONG = T.MATRUONG AND KQ.MAMT = '1' AND TS.NAMDUTHI = '2010'
ORDER BY KQ.DIEMTHI DESC

--In tổng điểm thi của các thí sinh có mã trường là '018'.Thông tin cần SOBD, HOTEN, TONGDIEM
SELECT TS.HOTEN, KQ.SOBD, SUM(KQ.DIEMTHI) AS 'TONG DIEM' 
FROM dbo.KETQUA AS KQ , dbo.THISINH AS TS
WHERE TS.SOBD = KQ.SOBD  AND TS.MATRUONG = '18'
GROUP BY KQ.SOBD,  TS.HOTEN

ALTER TABLE KETQUA ADD FOREIGN KEY (SOBD) REFERENCES THISINH
--Cho biết các thí sinh dự thi không đủ 6 môn trong năm 2010. Thông tin cần SOBD, HOTEN, NGAYSINH,  TENTRUONG
SELECT TS.SOBD, TS.HOTEN, TS.NGAYSINH, T.TENTRUONG, COUNT(KQ.MAMT) AS N'SLMONTHI' FROM dbo.TRUONG AS T ,dbo.THISINH  AS TS, dbo.MONTHI AS MT, KETQUA KQ
WHERE TS.MATRUONG= T.MATRUONG AND KQ.SOBD= TS.SOBD AND KQ.MAMT = MT.MAMT AND TS.NAMDUTHI = '2010'
GROUP BY TS.SOBD , TS.HOTEN , TS.NGAYSINH, T.TENTRUONG
HAVING COUNT(KQ.MAMT) < 6


INSERT INTO THISINH(SOBD, HOTEN, NGAYSINH, NOISINH, NAMDUTHI, MATRUONG)
VALUES(080191000007, N'NGUYỄN THỊ DIỄM CHINH', '2001-07-14', N'BẾN TRE', 2021, 111260)

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000007, 1, 0.0, N'VẮNG')
INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000007, 2, 10.0, N'ĐẠT')
INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000007, 3, 10.0, N'ĐẠT')
INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000007, 4, 10.0, N'ĐẠT')
INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000007, 5, 10.0, N'ĐẠT')
INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(080191000007, 6, 10.0, N'ĐẠT')


 --In danh sách thí sinh không vắng môn thi nào. Thông tin cần: SOBD, HOTEN, NGAYSINH, TENTRUONG.
 SELECT TS.SOBD, TS.HOTEN, TS.NGAYSINH, T.TENTRUONG,  COUNT(KQ.MAMT) AS N'SLMONTHI' FROM dbo.THISINH AS TS , dbo.TRUONG AS T, dbo.KETQUA AS KQ
 WHERE TS.SOBD = KQ.SOBD AND TS.MATRUONG = T.MATRUONG
 GROUP BY TS.SOBD , TS.HOTEN , TS.NGAYSINH, T.TENTRUONG
HAVING COUNT(KQ.MAMT) = 6

--Đếm số lượng thí sinh dự thi của từng trường. Thông tin cần: MATRUONG, TENTRUONG ,SOLUONG
SELECT T.MATRUONG, T.TENTRUONG, COUNT(TS.MATRUONG) AS N'SOLUONG' FROM dbo.THISINH AS TS , dbo.TRUONG AS T
WHERE TS.MATRUONG = T.MATRUONG
GROUP BY T.MATRUONG, T.TENTRUONG

--Đếm số lượng thí sinh có tổng điểm các môn thi >=48 của từng trường. Thông tin cần: MATRUONG, TENTRUONG, SOLUONG.
SELECT T.MATRUONG, T.TENTRUONG, COUNT(DISTINCT TS.SOBD) AS SOLUONG
FROM dbo.TRUONG AS T, dbo.KETQUA AS KQ, dbo.THISINH AS TS
WHERE TS.MATRUONG = T.MATRUONG AND TS.SOBD = KQ.SOBD 
GROUP BY T.MATRUONG, T.TENTRUONG, TS.SOBD
HAVING SUM(KQ.DIEMTHI) >= 48

--Đếm số lượng thí sinh vắng thi của từng trường. Thông tin cần: MATRUONG, TENTRUONG, SOLUONG
SELECT T.MATRUONG, T.TENTRUONG, COUNT(DISTINCT KQ.SOBD) AS SOLUONG
FROM TRUONG T, KETQUA KQ, THISINH TS WHERE KQ.SOBD = TS.SOBD AND TS.MATRUONG = T.MATRUONG AND KQ.GHICHU = N'VẮNG'
GROUP BY T.MATRUONG, T.TENTRUONG

INSERT INTO THISINH(SOBD, HOTEN, NGAYSINH, NAMDUTHI, MATRUONG)
VALUES(80191000010, N'GÀ', '2002-3-20', 2010, 18)

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(80191000010, 2, 4.5, N'KHÔNG ĐẠT')

INSERT INTO THISINH(SOBD, HOTEN, NGAYSINH, NAMDUTHI, MATRUONG)
VALUES(80191000011, N'NON', '2002-3-20', 2010, 111260),
	  (80191000012, N'NỜ GIÊ U', '2002-5-5', 2012, 111260)

INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(80191000011, 2, 3.5, N'KHÔNG ĐẠT'),
	  (80191000012, 2, 1.5, N'KHÔNG ĐẠT')


--Đếm số lượng thí sinh có điểm môn TOAN < 5 của từng trường. Thông tin cần: MATRUONG, TENTRUONG, SOLUONG
SELECT T.MATRUONG, T.TENTRUONG, COUNT(DISTINCT KQ.SOBD) AS SOLUONG
FROM TRUONG T, THISINH TS, KETQUA KQ, MONTHI MT
WHERE T.MATRUONG = TS.MATRUONG AND TS.SOBD = KQ.SOBD AND MT.MAMT = KQ.MAMT AND MT.TENMT = N'Toán' AND KQ.DIEMTHI < 5
GROUP BY T.MATRUONG, T.TENTRUONG
 

--Tìm danh sách các thí sinh có điểm thi môn TOAN cao nhất. Thông tin cần: SOBD, HOTEN,NGAYSINH,TENTRUONG, DIEMTHI
SELECT TS.SOBD, HOTEN, NGAYSINH, TENTRUONG, DIEMTHI
FROM TRUONG T, THISINH TS, KETQUA KQ
WHERE T.MATRUONG = TS.MATRUONG AND TS.SOBD = KQ.SOBD AND KQ.MAMT = 2 AND KQ.DIEMTHI = 
(
	SELECT MAX(DIEMTHI)
	FROM KETQUA 
)
GROUP BY TS.SOBD, TS.HOTEN, TS.NGAYSINH, T.TENTRUONG, KQ.DIEMTHI

-- In danh sách các thí sinh có tổng điểm các môn thi cao nhất. Thông tin cần: SOBD, HOTEN,NGAYSINH,TONGDIEM.

SELECT TOP 1 TS.SOBD, HOTEN, NGAYSINH, SUM(DIEMTHI) AS TONGDIEM 
FROM THISINH TS INNER JOIN KETQUA KQ ON TS.SOBD = KQ.SOBD
GROUP BY TS.SOBD, TS.HOTEN, TS.NGAYSINH
ORDER BY TONGDIEM DESC


INSERT INTO THISINH(SOBD, HOTEN, NGAYSINH, NAMDUTHI, MATRUONG)
VALUES(80191000008, N'Võ Đoàn Hoàng Long', '2001-03-03', 2010, 18),
	  (80191000009, N'Tiểu Lợi', '2001-03-30', 2010, 111222)
INSERT INTO KETQUA(SOBD, MAMT, DIEMTHI, GHICHU)
VALUES(80191000008, 1, 10, N'ĐẠT'),
	  (80191000008, 2, 10, N'ĐẠT'),
	  (80191000008, 3, 10, N'ĐẠT'),
	  (80191000008, 4, 10, N'ĐẠT'),
	  (80191000008, 5, 10, N'ĐẠT'),
	  (80191000008, 6, 10, N'ĐẠT'),
	  (80191000009, 1, 10, N'ĐẠT'),
	  (80191000009, 2, 10, N'ĐẠT'),
	  (80191000009, 3, 10, N'ĐẠT'),
	  (80191000009, 4, 10, N'ĐẠT'),
	  (80191000009, 5, 10, N'ĐẠT'),
	  (80191000009, 6, 10, N'ĐẠT')
-- In danh sách các trường có thí sinh đỗ thủ khoa trong kỳ thi năm 2010.
SELECT T.MATRUONG, T.TENTRUONG FROM (TRUONG T INNER JOIN THISINH TS ON TS.MATRUONG = T.MATRUONG)
INNER JOIN KETQUA KQ ON TS.SOBD = KQ.SOBD
WHERE TS.NAMDUTHI = 2010
GROUP BY T.MATRUONG, T.TENTRUONG, KQ.DIEMTHI
HAVING SUM(KQ.DIEMTHI) = 60

--In danh sách các thí sinh cùng trường với thí sinh đỗ thủ khoa trong kỳ thi năm 2010.
SELECT TS.* FROM THISINH TS INNER JOIN TRUONG T ON TS.MATRUONG = T.MATRUONG
WHERE TS.MATRUONG = 
(
	SELECT TOP 1 T.MATRUONG FROM (TRUONG T INNER JOIN THISINH TS ON TS.MATRUONG = T.MATRUONG)
	INNER JOIN KETQUA KQ ON TS.SOBD = KQ.SOBD
	WHERE TS.NAMDUTHI = 2010 
	GROUP BY T.MATRUONG, KQ.DIEMTHI
	HAVING SUM(KQ.DIEMTHI) = 60
)

-- In danh sách các trường không có thí sinh rớt tốt nghiệp.
SELECT T.* FROM (TRUONG T INNER JOIN THISINH TS ON TS.MATRUONG = T.MATRUONG)
INNER JOIN KETQUA KQ ON TS.SOBD = KQ.SOBD
WHERE T.MATRUONG != ALL
(
	SELECT T.MATRUONG FROM (TRUONG T INNER JOIN THISINH TS ON T.MATRUONG = TS.MATRUONG)
	INNER JOIN KETQUA KQ ON TS.SOBD = KQ.SOBD
	GROUP BY T.MATRUONG , KQ.GHICHU HAVING KQ.GHICHU != N'ĐẠT' 	
)
GROUP BY T.MATRUONG, T.TENTRUONG
